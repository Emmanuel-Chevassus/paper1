---
title: "dotdotentropy"
output: html_document
date: "2024-11-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(msentropy)
library(data.table)
pmf <- fread("C:/Users/Asus/Desktop/R codes/1112PMFMSCOMP.csv",header=TRUE)

```

```{r}
library(msentropy)

peaks_a <- matrix(c(pmf$mz, pmf$peat), ncol = 2, byrow = FALSE)
peaks_b <- matrix(c(pmf$mz, pmf$factor1), ncol = 2, byrow = FALSE)

calculate_entropy_similarity(peaks_a, peaks_b,ms2_tolerance_in_da = -1,ms2_tolerance_in_ppm = -1,clean_spectra = TRUE, min_mz = 12, max_mz = 130,max_peak_num=-1,
noise_threshold = -1)
```

```{r}
peaks <- matrix(c(pmf$mz, pmf$peat), ncol = 2, byrow = FALSE)
calculate_spectral_entropy(peaks)

peaks <- matrix(c(pmf$mz, pmf$PMOA), ncol = 2, byrow = FALSE)
calculate_spectral_entropy(peaks)

peaks <- matrix(c(pmf$mz, pmf$factor1), ncol = 2, byrow = FALSE)
calculate_spectral_entropy(peaks)
```

```{r}
peaks_a <- cbind(mz =pmf$mz,
intensity =pmf$factor1)
peaks_b <- cbind(mz =pmf$mz,
intensity =pmf$peat)
msentropy_similarity(peaks_a, peaks_b, ms2_tolerance_in_da = -1)
```

```{r}
pmf_clean <- na.omit(pmf)

peaks_a <- matrix(c(pmf_clean$mz, pmf_clean$PMOA_Chevassus), ncol = 2, byrow = FALSE) #reference ms
peaks_b <- matrix(c(pmf_clean$mz, pmf_clean$PMOA_Ovadnevaite), ncol = 2, byrow = FALSE) #actual ms
e1<-calculate_entropy_similarity(
  peaks_a, peaks_b,ms2_tolerance_in_da = 0.05,ms2_tolerance_in_ppm = -1,clean_spectra = TRUE, min_mz = 12, max_mz = 130,max_peak_num=-1,noise_threshold = -1)
e1

```
```{r}

```

```{r}
library(plotly)

# Define columns and rows for correlation matrix
columns <- c("factor31", "factor32", "factor33", "factor41", "factor42", "factor43", "factor44", "factor51", "factor52", "factor53", "factor54", "factor55")


rows <- c("LOOACrippa2013", "MOA_heutte", "AOOA_heutte", "ArcticHaze_Heutte", "HOA_heutte", "BBOA_Mohr_2012", "MOA_Crippa2013", "MSAOA_Chevassus", "MOOOA_Chevassus", "PMOA_Chevassus", "PeatOA_Chevassus", "BSOA_Moschos", "PBOA_Moschos", "MSA_OA_Moschos", "POA_Moschos", "Haze_Moschos", "OOA_Moschos", "BBOA_Aiken_2009", "BBOA_Elser_2016", "HOA_Crippa20133", "MSA_Crippa_2013", "COA_Crippa_2013", "BBOA_Crippa2013", "PMOA_Ovadnevaite", "wood", "peat", "charcoal_MH", "peatbrick", "charcoal_brick_MH", "IEPOX_SOA")


# Initialize an empty matrix for the results
correlation_matrix <- matrix(NA, nrow = length(rows), ncol = length(columns), 
                              dimnames = list(rows, columns))

# Calculate entropy similarity for each combination of rows and columns
for (col in columns) {
  for (row in rows) {
    peaks_a <- matrix(c(pmf_clean$mz, pmf_clean[[col]]), ncol = 2, byrow = FALSE)
    peaks_b <- matrix(c(pmf_clean$mz, pmf_clean[[row]]), ncol = 2, byrow = FALSE)
    
    correlation_matrix[row, col] <- calculate_entropy_similarity(
      peaks_a, peaks_b,
      ms2_tolerance_in_da = 0.05,
      ms2_tolerance_in_ppm = -1,
      clean_spectra = TRUE,
      min_mz = 12,
      max_mz = 130,
      max_peak_num = -1,
      noise_threshold = -1
    )
  }
}

# Convert the matrix to a data frame for plotting
correlation_df <- as.data.frame(as.table(correlation_matrix))
names(correlation_df) <- c("Row", "Column", "Value")

# Create the heatmap using plotly
plot <- plot_ly(
  data = correlation_df,
  x = ~Column,
  y = ~Row,
  z = ~Value,
  type = "heatmap",
  colors = colorRamp(c("blue", "white", "red"))
) %>%
  layout(
    title = "Entropy Similarity Correlation Matrix",
    xaxis = list(title = "Factors"),
    yaxis = list(title = "Metrics"),
    coloraxis = list(colorbar = list(title = "Entropy Similarity"))
  )

plot
```





```{r}
pmf_clean <- na.omit(pmf)


peaks_a <- matrix(c(pmf_clean$mz, pmf_clean$factor4), ncol = 2, byrow = FALSE) #reference ms
peaks_b <- matrix(c(pmf_clean$mz, pmf_clean$PMOA), ncol = 2, byrow = FALSE) #actual ms
calculate_entropy_similarity(
  peaks_a, peaks_b,ms2_tolerance_in_da = 0.05,ms2_tolerance_in_ppm = -1,clean_spectra = TRUE, min_mz = 12, max_mz = 130,max_peak_num=-1,noise_threshold = -1)


```


```{r}
pmf_subset <- data.frame(
  factor4 = pmf$factor4,
  MSAOApaper1 = pmf$MSAOApaper1,mz=pmf$mz
)
pmf_subset <- na.omit(pmf_subset)

peaks_a <- matrix(c(pmf_subset$mz, pmf_subset$factor4), ncol = 2, byrow = FALSE) #reference ms
peaks_b <- matrix(c(pmf_subset$mz, pmf_subset$MSAOApaper1), ncol = 2, byrow = FALSE) #actual ms
calculate_entropy_similarity(
  peaks_a, peaks_b,ms2_tolerance_in_da = 0.05,ms2_tolerance_in_ppm = -1,clean_spectra = TRUE, min_mz = 12, max_mz = 130,max_peak_num=-1,noise_threshold = -1)


```

```{r}
library(plotly)
# Extract entropy similarity values for factor31
factor31_values <- sapply(rows, function(row) {
  peaks_a <- matrix(c(pmf_clean$mz, pmf_clean$factor42), ncol = 2, byrow = FALSE)
  peaks_b <- matrix(c(pmf_clean$mz, pmf_clean[[row]]), ncol = 2, byrow = FALSE)
  
  calculate_entropy_similarity(
    peaks_a, peaks_b,
    ms2_tolerance_in_da = 0.05,
    ms2_tolerance_in_ppm = -1,
    clean_spectra = TRUE,
    min_mz = 12,
    max_mz = 130,
    max_peak_num = -1,
    noise_threshold = -1
  )
})

# Create a data frame
factor31_df <- data.frame(Row = rows, Value = factor31_values)

# Order data by similarity values (highest to lowest)
factor31_df <- factor31_df[order(-factor31_df$Value), ]

# Create the plot
plot1 <- plot_ly(
  data = factor31_df,
  x = ~reorder(Row, -Value),  # Order by highest value
  y = ~Value,
  type = "bar",
  marker = list(color = ~Value, colorscale = "RdBu", showscale = TRUE)
) %>%
  layout(
    title = "Entropy Similarity for factor 1",
    xaxis = list(title = "Metrics", tickangle = 45),
    yaxis = list(title = "Entropy Similarity"),
    coloraxis = list(colorbar = list(title = "Similarity"))
  )
######################################

# Extract entropy similarity values for factor31
factor31_values <- sapply(rows, function(row) {
  peaks_a <- matrix(c(pmf_clean$mz, pmf_clean$factor42), ncol = 2, byrow = FALSE)
  peaks_b <- matrix(c(pmf_clean$mz, pmf_clean[[row]]), ncol = 2, byrow = FALSE)
  
  calculate_entropy_similarity(
    peaks_a, peaks_b,
    ms2_tolerance_in_da = 0.05,
    ms2_tolerance_in_ppm = -1,
    clean_spectra = TRUE,
    min_mz = 12,
    max_mz = 130,
    max_peak_num = -1,
    noise_threshold = -1
  )
})

# Create a data frame
factor31_df <- data.frame(Row = rows, Value = factor31_values)

# Order data by similarity values (highest to lowest)
factor31_df <- factor31_df[order(-factor31_df$Value), ]

# Create the plot
plot2 <- plot_ly(
  data = factor31_df,
  x = ~reorder(Row, -Value),  # Order by highest value
  y = ~Value,
  type = "bar",
  marker = list(color = ~Value, colorscale = "RdBu", showscale = TRUE)
) %>%
  layout(
    title = "Entropy Similarity for factor 3",
    xaxis = list(title = "Metrics", tickangle = 45),
    yaxis = list(title = "Entropy Similarity"),
    coloraxis = list(colorbar = list(title = "Similarity"))
  )
#############################################################
# Extract entropy similarity values for factor31
factor31_values <- sapply(rows, function(row) {
  peaks_a <- matrix(c(pmf_clean$mz, pmf_clean$factor43), ncol = 2, byrow = FALSE)
  peaks_b <- matrix(c(pmf_clean$mz, pmf_clean[[row]]), ncol = 2, byrow = FALSE)
  
  calculate_entropy_similarity(
    peaks_a, peaks_b,
    ms2_tolerance_in_da = 0.05,
    ms2_tolerance_in_ppm = -1,
    clean_spectra = TRUE,
    min_mz = 12,
    max_mz = 130,
    max_peak_num = -1,
    noise_threshold = -1
  )
})

# Create a data frame
factor31_df <- data.frame(Row = rows, Value = factor31_values)

# Order data by similarity values (highest to lowest)
factor31_df <- factor31_df[order(-factor31_df$Value), ]

# Create the plot
plot3 <- plot_ly(
  data = factor31_df,
  x = ~reorder(Row, -Value),  # Order by highest value
  y = ~Value,
  type = "bar",
  marker = list(color = ~Value, colorscale = "RdBu", showscale = TRUE)
) %>%
  layout(
    title = "Entropy Similarity for factor 2",
    xaxis = list(title = "Metrics", tickangle = 45),
    yaxis = list(title = "Entropy Similarity"),
    coloraxis = list(colorbar = list(title = "Similarity"))
  )
# Extract entropy similarity values for factor31
factor31_values <- sapply(rows, function(row) {
  peaks_a <- matrix(c(pmf_clean$mz, pmf_clean$factor44), ncol = 2, byrow = FALSE)
  peaks_b <- matrix(c(pmf_clean$mz, pmf_clean[[row]]), ncol = 2, byrow = FALSE)
  
  calculate_entropy_similarity(
    peaks_a, peaks_b,
    ms2_tolerance_in_da = 0.05,
    ms2_tolerance_in_ppm = -1,
    clean_spectra = TRUE,
    min_mz = 12,
    max_mz = 130,
    max_peak_num = -1,
    noise_threshold = -1
  )
})

# Create a data frame
factor31_df <- data.frame(Row = rows, Value = factor31_values)

# Order data by similarity values (highest to lowest)
factor31_df <- factor31_df[order(-factor31_df$Value), ]

# Create the plot
plot4 <- plot_ly(
  data = factor31_df,
  x = ~reorder(Row, -Value),  # Order by highest value
  y = ~Value,
  type = "bar",
  marker = list(color = ~Value, colorscale = "RdBu", showscale = TRUE)
) %>%
  layout(
    title = "Entropy Similarity for factor 4",
    xaxis = list(title = "Metrics", tickangle = 45),
    yaxis = list(title = "Entropy Similarity"),
    coloraxis = list(colorbar = list(title = "Similarity"))
  )


plot1
plot2
plot3
plot4
```

```{r}
library(plotly)

factors <- c("factor31", "factor32", "factor33", "factor41", "factor42", "factor43", "factor44", "factor51", "factor52", "factor53", "factor54", "factor55")

plots <- list()

for (factor in factors) {
  factor_values <- sapply(rows, function(row) {
    peaks_a <- matrix(c(pmf_clean$mz, pmf_clean[[factor]]), ncol = 2, byrow = FALSE)
    peaks_b <- matrix(c(pmf_clean$mz, pmf_clean[[row]]), ncol = 2, byrow = FALSE)
    
    calculate_entropy_similarity(
      peaks_a, peaks_b,
      ms2_tolerance_in_da = 0.05,
      ms2_tolerance_in_ppm = -1,
      clean_spectra = TRUE,
      min_mz = 12,
      max_mz = 130,
      max_peak_num = -1,
      noise_threshold = -1
    )
  })
  
  factor_df <- data.frame(Row = rows, Value = factor_values)
  factor_df <- factor_df[order(-factor_df$Value), ]
  
  p <- plot_ly(
    data = factor_df,
    x = ~reorder(Row, -Value),
    y = ~Value,
    type = "bar",
    marker = list(color = ~Value, colorscale = "RdBu", showscale = TRUE)
  ) %>%
    layout(
      title = paste("Entropy Similarity with", factor),
      xaxis = list(title = "Metrics", tickangle = 45),
      yaxis = list(title = "Entropy Similarity"),
      coloraxis = list(colorbar = list(title = "Similarity"))
    )
  
  plots <- append(plots, list(p))
}

final_plot <- subplot(plots, ncol = 1)

final_plot

```

```{r}
library(plotly)

factors <- c("factor31", "factor32", "factor33", "factor41", "factor42", "factor43", "factor44", "factor51", "factor52", "factor53", "factor54", "factor55")

plots <- list()

for (factor in factors) {
  factor_values <- sapply(rows, function(row) {
    peaks_a <- matrix(c(pmf_clean$mz, pmf_clean[[factor]]), ncol = 2, byrow = FALSE)
    peaks_b <- matrix(c(pmf_clean$mz, pmf_clean[[row]]), ncol = 2, byrow = FALSE)
    
    calculate_entropy_similarity(
      peaks_a, peaks_b,
      ms2_tolerance_in_da = 0.05,
      ms2_tolerance_in_ppm = -1,
      clean_spectra = TRUE,
      min_mz = 12,
      max_mz = 130,
      max_peak_num = -1,
      noise_threshold = -1
    )
  })
  
  factor_df <- data.frame(Row = rows, Value = factor_values)
  factor_df <- factor_df[order(-factor_df$Value), ]
  
  p <- plot_ly(
    data = factor_df,
    x = ~reorder(Row, -Value),
    y = ~Value,
    type = "bar",
    marker = list(color = ~Value, colorscale = "RdBu", showscale = TRUE)
  ) %>%
    layout(
      title = paste("Entropy Similarity with", factor),
      xaxis = list(title = "Metrics", tickangle = 45),
      yaxis = list(title = "Entropy Similarity"),
      coloraxis = list(colorbar = list(title = "Similarity"))
    )
  
  plots <- append(plots, list(p))
}

final_plot <- subplot(plots, nrows = length(factors), shareX = FALSE, titleX = TRUE)

final_plot

```

```{r}
library(plotly)

factors <- c("factor31", "factor32", "factor33", "factor41", "factor42", "factor43", "factor44", "factor51", "factor52", "factor53", "factor54", "factor55")

top_rows <- c()
top_values <- c()
top_factors <- c()

for (factor in factors) {
  factor_values <- sapply(rows, function(row) {
    peaks_a <- matrix(c(pmf_clean$mz, pmf_clean[[factor]]), ncol = 2, byrow = FALSE)
    peaks_b <- matrix(c(pmf_clean$mz, pmf_clean[[row]]), ncol = 2, byrow = FALSE)
    
    calculate_entropy_similarity(
      peaks_a, peaks_b,
      ms2_tolerance_in_da = 0.05,
      ms2_tolerance_in_ppm = -1,
      clean_spectra = TRUE,
      min_mz = 12,
      max_mz = 130,
      max_peak_num = -1,
      noise_threshold = -1
    )
  })
  
  max_index <- which.max(factor_values)
  top_rows <- c(top_rows, rows[max_index])
  top_values <- c(top_values, factor_values[max_index])
  top_factors <- c(top_factors, factor)
}

summary_df <- data.frame(Factor = top_factors, Row = top_rows, Value = top_values)
summary_df <- summary_df[order(-summary_df$Value), ]

final_plot <- plot_ly(
  data = summary_df,
  x = ~reorder(Factor, -Value),
  y = ~Value,
  type = "bar",
  marker = list(color = ~Value, colorscale = "RdBu", showscale = TRUE)
) %>%
  layout(
    title = "Highest Entropy Similarity for Each Factor",
    xaxis = list(title = "Factors", tickangle = 45),
    yaxis = list(title = "Entropy Similarity"),
    coloraxis = list(colorbar = list(title = "Similarity"))
  )

final_plot
```


```{r}
library(plotly)
columns <- c("factor31", "factor32", "factor33", "factor41", "factor42", "factor43", "factor44", "factor51", "factor52", "factor53", "factor54", "factor55")


# Extract entropy similarity values for factor31
factor31_values <- sapply(rows, function(row) {
  peaks_a <- matrix(c(pmf_clean$mz, pmf_clean$factor55), ncol = 2, byrow = FALSE)
  peaks_b <- matrix(c(pmf_clean$mz, pmf_clean[[row]]), ncol = 2, byrow = FALSE)
  
  calculate_entropy_similarity(
    peaks_a, peaks_b,
    ms2_tolerance_in_da = 0.05,
    ms2_tolerance_in_ppm = -1,
    clean_spectra = TRUE,
    min_mz = 12,
    max_mz = 130,
    max_peak_num = -1,
    noise_threshold = -1
  )
})

# Create a data frame
factor31_df <- data.frame(Row = rows, Value = factor31_values)

# Order data by similarity values (highest to lowest)
factor31_df <- factor31_df[order(-factor31_df$Value), ]

# Create the plot
plot1 <- plot_ly(
  data = factor31_df,
  x = ~reorder(Row, -Value),  # Order by highest value
  y = ~Value,
  type = "bar",
  marker = list(color = ~Value, colorscale = "RdBu", showscale = TRUE)
) %>%
  layout(
    title = "Entropy Similarity for factor 1",
    xaxis = list(title = "Metrics", tickangle = 45),
    yaxis = list(title = "Entropy Similarity"),
    coloraxis = list(colorbar = list(title = "Similarity"))
  )
plot1
```

```{r}
library(data.table)
library(dplyr)
library(tidyr)
library(msentropy)
pmf <- fread("C:/Users/Asus/Desktop/R codes/0809PMFMSCOMPprofiles.csv",header=TRUE)
ref<- fread("C:/Users/Asus/Desktop/R codes/0809PMFMSCOMP.csv",header=TRUE)
pmf <- pmf %>%
  inner_join(ref, by = "mz") %>%
  select(where(~ !all(is.na(.))))%>%
  select(mz, factor66, LOOACrippa2013)%>%
  drop_na()

peaks_a <- matrix(c(pmf$mz, pmf$LOOACrippa2013), ncol = 2, byrow = FALSE) #reference ms
peaks_b <- matrix(c(pmf$mz, pmf$factor66), ncol = 2, byrow = FALSE) #actual ms
e1<-calculate_entropy_similarity(
  peaks_a, peaks_b,ms2_tolerance_in_da = 0.05,ms2_tolerance_in_ppm = -1,clean_spectra = TRUE, min_mz = 12, max_mz = 130,max_peak_num=-1,noise_threshold = -1)
e1

#############
pmf <- fread("C:/Users/Asus/Desktop/R codes/book2.csv",header=TRUE)
ref<- fread("C:/Users/Asus/Desktop/R codes/0809PMFMSCOMP.csv",header=TRUE)
pmf <- pmf %>%
  inner_join(ref, by = "mz") %>%
  select(where(~ !all(is.na(.))))

output_file <- "C:/Users/Asus/Desktop/R codes/pmfadjusted.csv"

write.csv(pmf, file = output_file, row.names = FALSE)
```


```{r}
pmf <- fread("C:/Users/Asus/Desktop/R codes/0809PMFMSCOMPprofiles.csv",header=TRUE)
str(ref)
```


```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

